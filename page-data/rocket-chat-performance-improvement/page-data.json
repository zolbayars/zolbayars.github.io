{"componentChunkName":"component---node-modules-gatsby-theme-chronoblog-src-templates-post-js","path":"/rocket-chat-performance-improvement","result":{"data":{"mdx":{"id":"ba67ebb3-13fe-5ce3-aeac-5a53ca0db54a","excerpt":"Running multiple instances of Rocket.Chat back-end service Our single instance of Rocket.Chat was working well until the latest v0.7 updatesâ€¦","frontmatter":{"title":"Rocket.Chat Performance Improvement","date":"2019-01-29T00:00:00.000Z","description":"Practical guide for running multiple Rocket.Chat services","tags":["Rocket.Chat"],"cover":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsSAAALEgHS3X78AAAClElEQVQoz62SSU/bUBRGvWihzCgEJcGZpGAnhKShDMEUUFup6pKYDEpCRFqJfxAvEHvwij/UZdfdoLrLqgwtIMoYMtvvvct9RqJIdNknXdkbH5/vu08Q/vdZSbW1VMrS0mlTU1fNiqq2NrNZKLuCiwvuQGyr2ylX+twT2pAY0/rd0UrPqLzljy0tXP05LV9eXGyaFqnU6w2t0WxqzVZLE/IFgFwOYK0EkM8DlPCJwH3f+PJuOD4PzxwyDHhi4AxOw5AYh17XJARjy7vHBz/24R9HQIi1ssLsSaWYqar4gyzsDXqUbTGyBKKUbPeMhq0ux7jVPSLhewS84eQ2frvXMS0gFjEBmEUptRhjlrCxwdjHT4ytrjKGQJrJouUaGAOiorvCSfCHFeLwJdgLp8yH9Lqi4IvM7yDQOL+4guOTU3p7W2N8TNNkQrHIIJNhoKoMODCdxsgZMJy+Wd0rJWDYmyDY2wPwuUMCd2hG58BavQG/fp/Qm5sqNBpNQEsQSiVmd/cYmEGgQ5zTXYE4DI7FSZ9rgmHcJ8B2pwPtdoeaGB3tACODkEFASuWG8ADEMbz+pB5Ew0HxJRkWYw+GXSMyeKQ5G9jpmNyMIhQ41AbmChSKxaeGgZCiT0xOgVuaJ145yQY8k9yS8KWMSUkbSAiF65sqbbXawOGEENxykcL6OgAuxQYijF8bIxR9r0enFvmVISP+BOOxbUOMLEYUHcyWwRBAGaO8O0rZvWGhQGxgPv/XMKWCEY+/1V/PJGFMVog/orD++x5JN0YOz37Qv335bBwd/ITL6yrlC+lgn/ZSikUC5TIaph8Z5sCQwm92Yq8UcASmiSc0i4YRG8g7HJ96t/N976txeHQIZ2fntFq9hVqtbkPvAB/nDj8+5tX1AAAAAElFTkSuQmCC","aspectRatio":1.6134453781512605,"src":"/static/b4df13e8f74e43b56c6be0ea94065082/c4ecb/rocketchat_performance.png","srcSet":"/static/b4df13e8f74e43b56c6be0ea94065082/57ab0/rocketchat_performance.png 192w,\n/static/b4df13e8f74e43b56c6be0ea94065082/f4739/rocketchat_performance.png 384w,\n/static/b4df13e8f74e43b56c6be0ea94065082/c4ecb/rocketchat_performance.png 768w,\n/static/b4df13e8f74e43b56c6be0ea94065082/2ada3/rocketchat_performance.png 960w","srcWebp":"/static/b4df13e8f74e43b56c6be0ea94065082/dd090/rocketchat_performance.webp","srcSetWebp":"/static/b4df13e8f74e43b56c6be0ea94065082/ae504/rocketchat_performance.webp 192w,\n/static/b4df13e8f74e43b56c6be0ea94065082/fef30/rocketchat_performance.webp 384w,\n/static/b4df13e8f74e43b56c6be0ea94065082/dd090/rocketchat_performance.webp 768w,\n/static/b4df13e8f74e43b56c6be0ea94065082/596e5/rocketchat_performance.webp 960w","sizes":"(max-width: 768px) 100vw, 768px","presentationWidth":768,"presentationHeight":474},"resize":{"src":"/static/b4df13e8f74e43b56c6be0ea94065082/c4ecb/rocketchat_performance.png"}}}},"fields":{"slug":"/rocket-chat-performance-improvement"},"body":"function _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"Rocket.Chat Performance Improvement\",\n  \"date\": \"2019-01-29T00:00:00.000Z\",\n  \"cover\": \"./rocketchat_performance.png\",\n  \"description\": \"Practical guide for running multiple Rocket.Chat services\",\n  \"slug\": \"rocket-chat-performance-improvement\",\n  \"tags\": [\"Rocket.Chat\"]\n};\n\nvar makeShortcode = function makeShortcode(name) {\n  return function MDXDefaultShortcode(props) {\n    console.warn(\"Component \" + name + \" was not imported, exported, or provided by MDXProvider as global scope\");\n    return mdx(\"div\", props);\n  };\n};\n\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, [\"components\"]);\n\n  return mdx(MDXLayout, _extends({}, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"h3\", {\n    \"id\": \"running-multiple-instances-of-rocketchat-back-end-service\"\n  }, \"Running multiple instances of Rocket.Chat back-end service\"), mdx(\"p\", null, \"Our single instance of Rocket.Chat was working well until the latest v0.7 updates get installed. The clients were getting disconnected, a single CPU usage stuck at 100% and the nginx proxy was returning 502 in every 20 minutes!\"), mdx(\"p\", null, \"That's because the Node.js doesn't take advantage of the multi-core CPU natively. You need to manually configure and run multiple instances of Rocket.Chat on your current server (if it has multi-core CPU) or another one. But how?\"), mdx(\"ol\", null, mdx(\"li\", {\n    \"parentName\": \"ol\"\n  }, \"Enable ReplicaSet on your MongoDB\"), mdx(\"li\", {\n    \"parentName\": \"ol\"\n  }, \"Create separate systemd unit files for new Rocket.Chat instances\"), mdx(\"li\", {\n    \"parentName\": \"ol\"\n  }, \"Update the nginx proxy config\")), mdx(\"p\", null, \"The last 2 steps are already well documented on their official \", mdx(\"a\", {\n    \"href\": \"https://rocket.chat/docs/installation/manual-installation/multiple-instances-to-improve-performance/\",\n    \"parentName\": \"p\"\n  }, \"documentation\"), \". So, I'm gonna write about the first step which was the most time-consuming step for me.\"), mdx(\"p\", null, mdx(\"strong\", {\n    \"parentName\": \"p\"\n  }, \"How to actually enable ReplicaSet on your MongoDB?\")), mdx(\"p\", null, \"When I read the MongoDB \", mdx(\"a\", {\n    \"href\": \"https://docs.mongodb.com/manual/tutorial/deploy-replica-set/\",\n    \"parentName\": \"p\"\n  }, \"doc\"), \" about the ReplicaSet first, I couldn't really grasp the meaning of it. So here are the steps in an easy, more digestible way:\"), mdx(\"ul\", null, mdx(\"li\", {\n    \"parentName\": \"ul\"\n  }, mdx(\"p\", {\n    \"parentName\": \"li\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"p\"\n  }, \"1.\"), \" Install MongoDB on at least 2 \", mdx(\"strong\", {\n    \"parentName\": \"p\"\n  }, \"other\"), \" machines (total 3 instances). It's advisable to have an odd number of MongoDB instances in order to enable ReplicaSet. If even, you will need to deploy an \", mdx(\"a\", {\n    \"href\": \"https://docs.mongodb.com/manual/core/replica-set-members/#replica-set-arbiters\",\n    \"parentName\": \"p\"\n  }, \"arbiter\"), \". Which seemed like an unnecessary complication to me\")), mdx(\"li\", {\n    \"parentName\": \"ul\"\n  }, mdx(\"p\", {\n    \"parentName\": \"li\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"p\"\n  }, \"2.\"), \" Enable ReplicaSet configuration on all instances by uncommenting \", mdx(\"em\", {\n    \"parentName\": \"p\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"replication\")), \" section of MongoDB configuration file  \", mdx(\"em\", {\n    \"parentName\": \"p\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"/etc/mongod.conf\")), \" and adding your new ReplicaSet name.In\\xA0our\\xA0case,\\xA0the\\xA0ReplicaSet's\\xA0name\\xA0will\\xA0be\\xA0\\\"\", mdx(\"em\", {\n    \"parentName\": \"p\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"rs1\")), \"\\\":\"))), mdx(\"pre\", null, mdx(\"code\", {\n    \"className\": \"language-js\",\n    \"parentName\": \"pre\"\n  }, \"replication: \\n    replSetName: \\\"rs1\\\"\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    \"parentName\": \"ul\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"li\"\n  }, \"3.\"), \" Add your host's IP address to the \", mdx(\"em\", {\n    \"parentName\": \"li\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"bindIp\")), \" section. Without this, the other instances of the ReplicaSet won't be able to access this instance. And, please don't put space between the IPs:\")), mdx(\"pre\", null, mdx(\"code\", {\n    \"className\": \"language-js\",\n    \"parentName\": \"pre\"\n  }, \"# network interfaces\\n# here, 10.1.1.20 is our host's ip \\nnet: \\n    port: 27017 \\n    bindIp: 127.0.0.1,10.1.1.20\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    \"parentName\": \"ul\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"li\"\n  }, \"4.\"), \" Add other members of the ReplicaSet to the \", mdx(\"em\", {\n    \"parentName\": \"li\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"hosts\")), \" file. Even though we already bound our ips in the config, it'd advisable to configure ReplicaSet with hostnames:\")), mdx(\"pre\", null, mdx(\"code\", {\n    \"className\": \"language-js\",\n    \"parentName\": \"pre\"\n  }, \"# /etc/hosts\\n10.1.1.21 chat1 \\n10.1.1.22 chat2\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    \"parentName\": \"ul\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"li\"\n  }, \"5.\"), \" Configure ReplicaSet on chat0's mongo shell with following command:\")), mdx(\"pre\", null, mdx(\"code\", {\n    \"className\": \"language-js\",\n    \"parentName\": \"pre\"\n  }, \"rsconf = {  \\n   \\\"_id\\\":\\\"rs1\\\",\\n   \\\"version\\\":1,\\n   \\\"protocolVersion\\\":NumberLong(1),\\n   \\\"members\\\":[  \\n      {  \\n         \\\"_id\\\":0,\\n         \\\"host\\\":\\\"chat0:27017\\\",\\n         \\\"arbiterOnly\\\":false,\\n         \\\"buildIndexes\\\":true,\\n         \\\"hidden\\\":false,\\n         \\\"priority\\\":1,\\n         \\\"tags\\\":{  \\n \\n         },\\n         \\\"slaveDelay\\\":NumberLong(0),\\n         \\\"votes\\\":1\\n      },\\n      {  \\n         \\\"_id\\\":1,\\n         \\\"host\\\":\\\"chat1:27017\\\",\\n         \\\"arbiterOnly\\\":false,\\n         \\\"buildIndexes\\\":true,\\n         \\\"hidden\\\":false,\\n         \\\"priority\\\":1,\\n         \\\"tags\\\":{  \\n \\n         },\\n         \\\"slaveDelay\\\":NumberLong(0),\\n         \\\"votes\\\":1\\n      },\\n      {  \\n         \\\"_id\\\":2,\\n         \\\"host\\\":\\\"chat2:27017\\\",\\n         \\\"arbiterOnly\\\":false,\\n         \\\"buildIndexes\\\":true,\\n         \\\"hidden\\\":false,\\n         \\\"priority\\\":1,\\n         \\\"tags\\\":{  \\n \\n         },\\n         \\\"slaveDelay\\\":NumberLong(0),\\n         \\\"votes\\\":1\\n      }\\n   ]\\n}\\nrs.initiate(rsconf)\\n\")), mdx(\"ul\", null, mdx(\"li\", {\n    \"parentName\": \"ul\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"li\"\n  }, \"6.\"), \" Check ReplicaSet config. The chat0's \", mdx(\"em\", {\n    \"parentName\": \"li\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"stateStr\")), \" should be \", mdx(\"em\", {\n    \"parentName\": \"li\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"PRIMARY\")), \" and other two's should be \", mdx(\"em\", {\n    \"parentName\": \"li\"\n  }, mdx(\"strong\", {\n    \"parentName\": \"em\"\n  }, \"SECONDARY\")))), mdx(\"p\", null, \"If all those steps went smoothly, you should see logs with following content on your mongo log:\"), mdx(\"pre\", null, mdx(\"code\", {\n    \"className\": \"language-js\",\n    \"parentName\": \"pre\"\n  }, \"[ReplicationExecutor] Member chat1:27017 is now in state STARTUP\\n[ReplicationExecutor] Member chat2:27017 is now in state STARTUP\\n\")), mdx(\"p\", null, \"That's it. Now you're gonna be able to do the \", mdx(\"a\", {\n    \"href\": \"https://rocket.chat/docs/installation/manual-installation/multiple-instances-to-improve-performance/\",\n    \"parentName\": \"p\"\n  }, \"last 2 steps\"), \" without having a headache. And if you've encountered any error during this process, please feel free to ask on the comment section.\"));\n}\n;\nMDXContent.isMDXComponent = true;"}},"pageContext":{"id":"ba67ebb3-13fe-5ce3-aeac-5a53ca0db54a"}},"staticQueryHashes":["1961101537","2542493696"]}